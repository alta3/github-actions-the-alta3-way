#!/bin/bash

# scripts/reset_db.sh
# Resets the FIRM database for test mode by dropping and reinitializing it.
# Requires user to type "eraseDB" to proceed, preventing accidental data loss.
# Loads secrets from .env using set -a; source .env; set +a.
# Drops the 'firm' database using superuser credentials, then runs main.go to recreate it.
# Designed for Go 1.24.2 linux/amd64, with public usability.
# WARNING: This will DELETE ALL DATA in the firm database!
# Prerequisites: PostgreSQL, .env with PG_USER, PG_PASSWORD, etc., firm.conf.

# Exit on error
set -e

# Safety prompt to prevent accidental execution
echo "WARNING: This will DELETE ALL DATA in the firm database!"
echo "Type 'eraseDB' to continue or press Ctrl+C to abort:"
read -r confirm
if [ "$confirm" != "eraseDB" ]; then
    echo "âŒ Aborted: Input did not match 'eraseDB'."
    exit 1
fi

echo "âœ… Resetting FIRM database for test mode..."

# Check for PostgreSQL
if ! command -v psql &> /dev/null; then
    echo "âŒ PostgreSQL (psql) not found. Install it: sudo apt install postgresql"
    exit 1
fi

# Check for Go
if ! command -v go &> /dev/null; then
    echo "âŒ Go not found. Install Go 1.24.2: https://go.dev/dl/"
    exit 1
fi
go_version=$(go version | grep -o "go1.24.2")
if [ "$go_version" != "go1.24.2" ]; then
    echo "âŒ Requires Go 1.24.2 linux/amd64, found: $(go version)"
    exit 1
fi

# Check for .env
if [ ! -f ".env" ]; then
    echo "âŒ .env not found. Copy .env.example to .env and fill in credentials."
    exit 1
fi

# Check for firm.conf
if [ ! -f "firm.conf" ]; then
    echo "âŒ firm.conf not found. Create it with [settings] section."
    exit 1
fi

# Load secrets from .env
echo "ğŸ”‘ Loading secrets from .env..."
set -a
source .env
set +a

# Validate environment variables
if [ -z "$PG_USER" ] || [ -z "$PG_PASSWORD" ] || [ -z "$PG_HOST" ] || [ -z "$PG_PORT" ] || [ -z "$PG_DB" ]; then
    echo "âŒ Missing required environment variables (PG_USER, PG_PASSWORD, PG_HOST, PG_PORT, PG_DB)."
    exit 1
fi

# Drop database using psql
echo "ğŸ—‘ï¸ Dropping database $PG_DB..."
PGPASSWORD=$PG_PASSWORD psql -U $PG_USER -h $PG_HOST -p $PG_PORT -d postgres -c "DROP DATABASE IF EXISTS $PG_DB;" || {
    echo "âŒ Failed to drop database. Check credentials in .env."
    exit 1
}

# Reinitialize database via main.go
echo "ğŸ› ï¸ Reinitializing database $PG_DB..."
go run main.go || {
    echo "âŒ Failed to reinitialize database. Check main.go, .env, and firm.conf."
    exit 1
}

echo "âœ… Database reset successfully!"
echo "ğŸ“ Schema applied from db/schema.sql."
echo "ğŸš€ Ready for testing with updated schema."